<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Nanjing Isochrone Map</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
<script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
<link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<style>
  body { margin: 0; padding: 0; }
  #map { position: absolute; top: 0; bottom: 0; width: 100%; }
  .controls {
    position: absolute;
    background: white;
    padding: 10px;
    margin: 10px;
    border-radius: 5px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    z-index: 1;
  }
  .controls select, .controls input {
    margin: 5px 0;
    width: 100%;
  }
</style>
</head>
<body>
<div id="map"></div>
<div class="controls">
  <label>交通模式:</label>
  <select id="profile">
    <option value="walking">Walking</option>
    <option value="cycling">Cycling</option>
    <option value="driving">Driving</option>
  </select>
  <label>时间(分钟):</label>
  <input type="number" id="minutes" value="10" min="1" max="60" />
</div>
<script>
  mapboxgl.accessToken = 'pk.eyJ1Ijoiemhhb2JvIiwiYSI6ImNqaW85NzNrdDA3OXczcHQ5aTZvYmtjc2gifQ.ummEQxsRIweCIdv9CRRzOw'; // 替换成你的 Mapbox Token
  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v11',
    center: [118.7969, 32.0603], // 南京中心
    zoom: 11
  });

  let marker = new mapboxgl.Marker({ draggable: true })
    .setLngLat([118.7969, 32.0603])
    .addTo(map);

  marker.on('dragend', getIsochrone);

  document.getElementById('profile').addEventListener('change', getIsochrone);
  document.getElementById('minutes').addEventListener('input', getIsochrone);

  async function getIsochrone() {
    const lngLat = marker.getLngLat();
    const profile = document.getElementById('profile').value;
    const minutes = document.getElementById('minutes').value;

    const query = `https://api.mapbox.com/isochrone/v1/mapbox/${profile}/${lngLat.lng},${lngLat.lat}?contours_minutes=${minutes}&polygons=true&access_token=${mapboxgl.accessToken}`;

    try {
      const response = await axios.get(query);
      const data = response.data;

      if (map.getSource('isochrone')) {
        map.getSource('isochrone').setData(data);
      } else {
        map.addSource('isochrone', {
          type: 'geojson',
          data: data
        });
        map.addLayer({
          id: 'isochrone-layer',
          type: 'fill',
          source: 'isochrone',
          layout: {},
          paint: {
            'fill-color': '#5a3fc0',
            'fill-opacity': 0.3
          }
        });
      }
    } catch (error) {
      console.error('Isochrone API error:', error);
    }
  }

  map.on('load', getIsochrone);
</script>
</body>
</html>
